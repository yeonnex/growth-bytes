2014년에 Airbnb의 엔지니어들은 회사 내에서 복잡한 데이터 워크플로를 관리하는데 어려움에 직면했다. 이러한 문제를 해결하기 위해 그들은 워크플로를 작성 및 예약하고 웹 인터페이스를 기본으로 제공하여 워크플로 운영을 모니터링할 수 있는 오픈소스 솔루션인 airflow 를 개발하기 시작했다.

결과적으로 이제 많은 대기업에서 airflow를 사용하여 중요한 데이터 프로세스를 구현하고 있다.

데이터 레이크/플랫폼, 머신러닝 모델 등을 구축하는 프로젝트에서 airflow를 핵심 구성요소로 채택하는 사례가 많다.

1장에서는 `데이터 파이프라인`의 개념을 살펴보고 apache airflow 가 이런 파이프라인의 구축을 어떻게 지원하는지 살펴본다.

2장에서 airflow의 첫번째 파이프라인을 구축하는 방법을 설명한다. 파이프라인을 구축한 후, 우리는 파이프라인을 실행하고 airflow의 **웹 인터페이스를 사용하여 진행상황을 모니터링하는 방법을 확인한다.**


# Chapter 1 Apache Airflow 살펴보기

- airflow와 같은 워크플로 관리 솔루션을 이용해 태스크 및 태스크 의존적인 그래프로 데이터 파이프라인을 표현하는 방법을 알아보자.

## 데이터 파이프라인 소개

일반적인 데이터 파이프라인은 원하는 결과를 얻기 위해 실행되는 여러 태스크 또는 동작으로 구성한다.

![[Pasted image 20250322110656.png]]
이런 형태의 그래프는 일반적으로 **방향성 비순환 그래프(Directed Acyclic Graph, DAG(대그)** 라고 부른다. 이 비순환 속성은 태스크 간의 순환 실행을 방지하기 때문에 매우 중요하다. 그래프를 실행할 때 순환 의존성이 문제를 발생시킬 수 있기 때문이다.

airflow 의 DAG의 **비순환 속성**은 태스크 그래프를 효율적으로 해결하고 실행하기 위해 사용된다.

## 파이프라인 그래프 실행
DAG는 파이프라인 실행을 위한 단순한 알고리즘을 제공한다는 이점을 제공한다. 알고리즘을 개념적으로 설명하면 다음 단계와 같다.

1. 그래프 안에 태스크는 각각 개방된(open)상태이며(=미완료) 다음과 같은 단계를 수행한다.
	- 각각의 화살표 끝점은 태스크를 향하며 다음 태스크로 향하기 전에 이전 태스크가 완료되었는지 확인한다(`1단계`)
	- 태스크가 완료되면 다음에 실행해야할 태스크를 대기열에 추가한다
2. 실행 대기열에 있는 태스크를 실행하고 태스크 수행이 완료되면 완료 표시를 한다.
3. 그래프의 모든 태스크가 완료될 때까지 `1단계`로 돌아간다.
![[Pasted image 20250322111622.png]]

## 그래프 파이프라인과 절차적 스크립트 파이프라인 비교

그래프 파이프라인 표현이 태스크와 태스크 사이에 대한 의존성을 직관적으로 설명하지만, 간단한 스크립트를 이용해서 위 세 단계를 선형 체인 형태로 실행할 수 있다.

그래프 기반 접근 방식의 이점을 설명하기 위해 좀 더 복잡한 예를 생각해보자. 우산 회사의 대표가 날씨 대시보드 파이프라인에 머신러닝을 적용하여 운영효율을 높이고자 한다. 이를 위해 우산 판매와 날씨 변화 패턴을 상호 연관시켜 머신러닝 모델을 만드는 데이터파이프라인을 구현한다. 그리고 만들어진 모델을 이용해 해당 주간 일기 예보에 따라 향후 몇 주 동안 우산의 수요가 얼마나 될지를 예측한다.

![[Pasted image 20250322112227.png]]

머신러닝 모델을 훈련하기 위한 파이프라인 구측을 위해 다음 단계가 필요하다.

1. 판매 데이터 준비 과정:
	- 원천 시스템에서 판매 데이터 추출
	- 요구 사항에 맞게 데이터 정제 및 변환
2. 날씨 데이터 준비 과정:
	- API로부터 날씨 데이터 가져오기
	- 요구 사항에 맞게 데이터 정제 및 변환
3. 수요 예측 모델 생성을 위해 판매 및 날씨 데이터 세트를 결합하여 새로운 데이터 세트 생성
4. 생성된 데이터셋을 이용해 머신러닝 모델 훈련
5. 머신러닝 모델을 배포하여 비즈니스에 사용

이 파이프라인은 앞에서 본 그래프 기반 표현 방법을 사용하여 각 태스크를 노드로 생성하고 태스크 간의 의존성을 화살표 끝점으로 연결하여 표현할 수 있다.

간단한 예와 중요한 차이점은, 파이프라인의 첫번째 단계가 독립적인 태스크 두 개로 분리되어 있다는 것이다. 이 두 개의 태스크(날씨/판매 데이터 가져오기 및 정제)는 서로 다른 데이터 세트를 포함하기 때문에 독립적으로 구성될 수 있다. 이를 파이프라인의 그래프로 표현하면 두 가지의 개별적인 태스크로 명확하게 분리할 수 있다.

![[Pasted image 20250322112845.png]]

그래프에 실행 알고리즘을 적용하면 **태스크를 병렬로 실행할 수 있기 때문**에 가용 컴퓨팅 리소스를 더 효율적으로 활용할 수 있다. 그로 인해 태스크를 순차적으로 실행하는 것보다 전체 파이프라인의 실행 시간을 줄일 수 있다.

==**그래프 기반 표현의 또 다른 특성은 전체 작업을 하나의 모놀리식(단일) 스크립트 또는 프로세스로 구성되는 것이 아니라 파이프라인을 작은 점진적인 태스크로 명확하게 분리할 수 있다는 것이다. 모놀리식 스크립트가 구현 초기에는 그다지 문제가 되지 않지만, 파이프라인의 중간 태스크가 실패하면 전체 스크립트를 재실행해야하기 때문에 비효율적이다. 반면에 그래프 기반 표현에서는 실패한 태스크(그리고 그 이후 태스크)만 재실행하면 되므로 효율적으로 구성할 수 있다.**==

## 워크플로 매니저를 이용한 파이프라인 실행

의존성 있는 그래프 태스크 실행에 대한 어려움은 기존에도 계속 있었던 문제이다. 과거 수년간 이 문제를 해결하기 위해 '워크플로 매니지먼트' 솔루션이 다양하게 개발되었다.

다음은 몇몇 유명한 `워크플로 관리 시스템` 에 대한 요약이다.


| 이름        | 시작회사     | 워크플로 정의 | 개발 언어 | 스케줄 관리 | 백필  | 사용자 인터페이스 | 플랫폼 설치   | 수평 확장 |
| --------- | -------- | ------- | ----- | ------ | --- | --------- | -------- | ----- |
| Airflow   | Airbnb   | 파이썬     | 파이썬   | Y      | Y   | Y         | Anywhere | Y     |
| Argo      | Applatix | yml     | Go    | 서드파티   |     | Y         | K8s      | Y     |
| Azkaban   | LinkedIn | yml     | Java  | Y      | N   | Y         | Anywhere |       |
| Conductor | Netflix  | yml     | Java  | N      |     | Y         | Anywhere | Y     |
| Luigi     | Spotify  | 파이썬     | 파이썬   | N      | Y   | Y         | Anywhere | Y     |
| Nifi      | NSA      | UI      | Java  | Y      | N   | Y         | Anywhere | Y     |
| Oozie     |          | XML     | Java  | Y      | Y   | Y         | Hadoop   | Y     |

>백필(Backfilling): 하나의 플로(Airflow에서는 DAG)를 특정 옵션(기간) 기준으로 다시 실행할 수 있는 기능을 말한다. 태스크가 며칠동안 실패하거나 새롭게 만든 플로를 과거의 특정 시점부터 순차적으로 실행하고 싶을 때 수행한다.

이 워크플로 관리 도구들은 모두 장단점을 가지고 있지만, 제공하는 주요 기능은 의존성이 있는 다수 태스크가 포함된 파이프라인을 정의하고 실행하는 것이다.

이 도구들의 주요 차이점 중 하나는 워크플로 정의방식이다. 예를 들어 Oozie와 같은 도구는 xml 파일을 사용하여 워크플로를 정의하기 때문에 유연하지는 않다. Luigi 및 Airflow 와 같은 도구는 워크플로를 코드로 정의할 수 있다.

그 밖의 주요 차이점은 워크플로 관리자가 제공하는 기능의 범위이다. 예를 들어 Luigi는 워크플로 스케줄을 위한 기본 기능을 제공하지 않는다. 즉, 반복 스케줄로 워크플로를 실행하기 위해서는 cron 과 같은 추가 도구를 사용해야 한다. 어떤 도구들은 스케줄 계획, 모니터링, 사용자 웹 인터페이스 등과 같은 기능들도 포함하여 제공한다.
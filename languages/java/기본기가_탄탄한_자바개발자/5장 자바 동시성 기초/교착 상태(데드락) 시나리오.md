교착상태(Deadlock)는 두 개 이상의 트랜잭션이 서로가 보유한 자원을 기다리며 무한히 대기하는 상황을 말한다.

## 시나리오 설명
1. 스레드 A는 계좌 A에서 계좌 B로 돈을 송금하려고 시도한다.
	- 스레드 A는 `synchronized(A)`로 계좌 A의 잠금을 획득하고, 그 후 계좌 B에 대한 잠금을 시도(`synchronized(B)`)한다.

2. 스레드 B는 계좌 B에서 계좌 A로 돈을 송금하려고 시도한다.
	- 스레드 B는 `synchronized(B)` 로 계좌 B의 잠금을 획득하고, 그 후 계좌 A에 대한 잠금을 시도(`synchronized(A)`) 한다.

### 🚨 교착상태 발생! (데드락)

이 상황에서 데드락이 발생할 수 있다. 두 스레드가 서로 상대방이 가진 자원을 기다리며, 서로 무한히 대기하는 상황이기 때문이다.

1. 스레드 A는 계좌 A에 대한 잠금을 획득한 후 계좌 B에 대한 잠금을 요청한다.
2. 스레드 B는 계좌 B에 대한 잠금을 획득한 후 계좌 A에 대한 잠금을 요청한다.

## 해결 방법

이 문제를 해결하려면 **잠금 순서를 일관되게 지정하는 것이 중요하다.** 모든 스레드가 항상 같은 순서로 잠금을 획득하도록 해야 한다. 이를 위한 한가지 방법은 스레드에 순서를 지정하는 것이다. 예를 들어 고유한 계정 번호를 도입하고 '번호가 가장 낮은 계정 ID에 해당하는 잠금을 먼저 획득'이라는 규칙을 구현하는 것이다.

### 교착 상태를 피하는 방법
교착 상태를 피하기 위해선 잠금 순서를 고정시켜야 한다. 예를 들어 계좌의 `accountId`값을 기준으로 항상 작은 계좌부터 먼저 잠그는 방식으로 변경할 수 있다. 이렇게 하면, 두 스레드가 서로 다른 순서로 자원을 기다리는 상황을 방지할 수 있다.

#### 교착 상태를 방지한 코드 예시

```java
public class Account {

	private int balance;
	private int accountId;

	// 계좌 이체 메서드
	public boolean transferTo(Account other, int amount) {
		// accountId 기준으로 항상 잠금 순서가 동일하도록 고정
		Account firstLock = this.accountId < other.accountId ? this : other;
		Account secondLock = this.accountId < other.accountId ? other : this;
		// 먼저 작은 accountId를 가진 계좌부터 잠금
		synchronized (firstLock) {
			synchronized(secondLock) {
				if (this.balance >= amount) {
					this.balance -= amount;
					other.balance += amount;
					return true;
				}
			}
			return false;
		}
	}
}
```

`accountId`값을 기준으로 **작은 계좌부터 먼저 잠그고 큰 계좌는 그 후에 잠그는 방식**이 교착상태를 방지하는 이유는, **잠금 순서가 항상 일정하게 되기 때문이다.** 이 방식은 순환 대기를 방지할 수 있다.

### 데드락을 방지하는 방법
데드락의 핵심은 순환대기이다. 두 스레드가 서로 상대방이 가진 자원을 기다리면서 무한 대기하는 상황이 발생할 수 있다. 이를 방지하기 위해서는 자원에 접근하는 순서를 고정하여, 두 스레드가 서로 교차해서 자원을 기다리는 일이 발생하지 않도록 해야 한다.

### 작은 계좌부터 잠그는 걸로 잠금 순서를 지정한 방법이 데드락에서 안전한 이유
- 스레드 1이 계좌 A를 잠그고 계좌 B를 잠그려고 대기할 때, 스레드 B 또한 계좌 A 부터 무조건 잠금을 시도하나, 이미 스레드 1에 의해 잠겨있기 때문에 스레드 1의 일이 모두 끝난 후에야 잠금 로직을 실행할 수 있다.
- 작은 계좌부터 잠그는 순서를 고정하면, 두 스레드가 **항상 작은 계좌부터 잠그기 때문에** 스레드 1과 스레드 2는 서로 대기하지 않게 된다.

## 결론
`accountId`를 기준으로 작은 계좌부터 먼저 잠그고 큰 계좌는 그 후에 잠그는 방식은 잠금 순서를 일관되게 유지하기 때문에, 두 스레드가 서로 상대방이 가진 자원을 기다리며 순환대기에 빠지는 상황을 방지하고 교착 상태를 예방할 수 있다.